{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Work Hours</h1>

    <!-- Work Hours Distribution -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Work Distribution</h5>
                <select id="timeframeSelect" class="form-select" style="width: auto;">
                    <option value="day">Daily</option>
                    <option value="week">Weekly</option>
                    <option value="month">Monthly</option>
                    <option value="year">Yearly</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <canvas id="workDistributionChart" style="width: 100%; height: 400px;"></canvas>
        </div>
    </div>

    <!-- Log Work Hours -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Log Work Hours</h5>
        </div>
        <div class="card-body">
            <form id="workLogForm" method="POST">
                <div class="mb-3">
                    <label for="category" class="form-label">Category</label>
                    <select id="category" name="category" class="form-select" required>
                        <option value="Development">Development</option>
                        <option value="Meetings">Meetings</option>
                        <option value="Planning">Planning</option>
                        <option value="Research">Research</option>
                        <option value="Breaks">Breaks</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="hours" class="form-label">Hours</label>
                    <input type="number" id="hours" name="hours" class="form-control" step="0.5" min="0" required>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description" name="description" class="form-control" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Log Hours</button>
            </form>
        </div>
    </div>
</div>

<script>
let workDistributionChart = null;

function initializeWorkHours() {
    document.getElementById('timeframeSelect').addEventListener('change', (e) => {
        loadWorkHoursData(e.target.value);
    });

    // Load initial data
    loadWorkHoursData('day');

    // Handle form submission
    document.getElementById('workLogForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const response = await fetch('/api/work-hours', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: formData.get('category'),
                    hours: parseFloat(formData.get('hours')),
                    description: formData.get('description'),
                    timeframe: document.getElementById('timeframeSelect').value
                })
            });
            if (response.ok) {
                loadWorkHoursData(document.getElementById('timeframeSelect').value);
                e.target.reset();
            }
        } catch (error) {
            console.error('Error logging work hours:', error);
        }
    });
}

async function loadWorkHoursData(timeframe) {
    try {
        const response = await fetch(`/api/work-hours/${timeframe}`);
        const data = await response.json();
        updateWorkDistributionChart(data);
    } catch (error) {
        console.error('Error loading work hours data:', error);
    }
}

function updateWorkDistributionChart(data) {
    const ctx = document.getElementById('workDistributionChart').getContext('2d');
    const colors = [
        '#4CAF50', // Development
        '#2196F3', // Meetings
        '#FFC107', // Planning
        '#9C27B0', // Research
        '#FF5722'  // Breaks
    ];

    if (workDistributionChart) {
        workDistributionChart.destroy();
    }

    workDistributionChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.categories,
            datasets: [{
                data: data.hours,
                backgroundColor: colors.slice(0, data.categories.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const hours = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((hours / total) * 100).toFixed(1);
                            return `${hours.toFixed(1)} hours (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', initializeWorkHours);
</script>
{% endblock %}
